{{define "title"}}Admin · Registration · lumgr{{end}}
{{define "content"}}
<div class="grid two">
    <div class="card">
        <h2 style="margin:0 0 8px;">Registration</h2>
        <div class="muted" style="margin-bottom: 12px;">Configure user registration settings.</div>

        <div class="card" style="padding:14px; margin-bottom:14px;">
            <h3 style="margin:0 0 8px; font-size: 14px;">Registration mode</h3>
            <form method="post" action="/admin/settings/registration" style="margin:0;">
                <div class="seg" style="margin-top:6px;">
                    <input id="rm_open" type="radio" name="mode" value="open" {{if eq .RegMode "open"
                        }}checked{{end}} />
                    <label for="rm_open">Open</label>
                    <input id="rm_inv" type="radio" name="mode" value="invite" {{if eq .RegMode "invite"
                        }}checked{{end}} />
                    <label for="rm_inv">Invite</label>
                    <input id="rm_closed" type="radio" name="mode" value="closed" {{if eq .RegMode "closed"
                        }}checked{{end}} />
                    <label for="rm_closed">Closed</label>
                </div>
                <div class="muted" style="margin-top: 8px; font-size: 12px;">Open = anyone can register. Invite = invite
                    code required. Closed = registration disabled.</div>
                <div style="display:flex; justify-content:flex-end; margin-top: 12px;">
                    <button class="btn primary" type="submit">Save</button>
                </div>
            </form>
        </div>

        {{if eq .RegMode "invite"}}
        <div class="card" style="padding:14px;">
            <h3 style="margin:0 0 8px; font-size: 14px;">Invite codes</h3>
            <div style="overflow-x:auto; width:100%; -webkit-overflow-scrolling:touch;">
                <table style="min-width: 860px;">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Uses</th>
                            <th>Expires</th>
                            <th>Home</th>
                            <th>Groups</th>
                            <th>Umask</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {{if not .Invites}}
                        <tr>
                            <td colspan="7" style="text-align: center; color: var(--text-muted); padding: 24px;">No
                                invite
                                codes created.</td>
                        </tr>
                        {{else}}
                        {{range .Invites}}
                        <tr>
                            <td class="cellWrap">
                                <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap; min-width:0;">
                                    <code style="min-width:0;">{{.ID}}</code>
                                    <button class="btn small" type="button" data-copy-invite-code="{{.ID}}"
                                        style="min-width:84px; white-space:nowrap; display:inline-flex; justify-content:center; align-items:center;">Copy</button>
                                </div>
                            </td>
                            <td>{{.UsedCount}}{{if gt .MaxUses 0}} / {{.MaxUses}}{{end}}</td>
                            <td>{{if .ExpiresAt.IsZero}}<span class="muted">never</span>{{else}}<span
                                    class="muted">{{.ExpiresAt}}</span>{{end}}</td>
                            <td>{{if .CreateHome}}Yes{{else}}No{{end}}</td>
                            <td class="cellWrap"><small>{{if .Groups}}{{range .Groups}}{{.}}
                                    {{end}}{{else}}-{{end}}</small></td>
                            <td><span class="muted">{{if .Umask}}{{.Umask}}{{else}}-{{end}}</span></td>
                            <td style="text-align:right;">
                                <form method="post" action="/admin/invites/delete" style="margin:0; display:inline;"
                                    onsubmit="return confirm('Delete invite code {{.ID}}? This action cannot be undone!');">
                                    <input type="hidden" name="invite_id" value="{{.ID}}" />
                                    <button class="btn danger small" type="submit">Del</button>
                                </form>
                            </td>
                        </tr>
                        {{end}}
                        {{end}}
                    </tbody>
                </table>
            </div>

            <script>
                async function copyInviteCode(text) {
                    if (!text) return false;
                    const value = text.trim();
                    try {
                        await navigator.clipboard.writeText(value);
                        return true;
                    } catch (e) {
                        try {
                            const el = document.createElement('textarea');
                            el.value = value;
                            el.setAttribute('readonly', '');
                            el.style.position = 'absolute';
                            el.style.left = '-9999px';
                            document.body.appendChild(el);
                            el.select();
                            const ok = document.execCommand('copy');
                            document.body.removeChild(el);
                            return !!ok;
                        } catch (e2) {
                            return false;
                        }
                    }
                }

                function setCopyFeedback(btn, ok) {
                    if (!btn) return;

                    const original = btn.getAttribute('data-copy-label') || btn.textContent;
                    if (!btn.getAttribute('data-copy-label')) {
                        btn.setAttribute('data-copy-label', original);
                    }

                    if (btn._copyFeedbackTimer) {
                        clearTimeout(btn._copyFeedbackTimer);
                    }

                    btn.textContent = ok ? 'Copied!' : 'Failed';
                    btn.disabled = true;

                    btn._copyFeedbackTimer = setTimeout(() => {
                        btn.textContent = btn.getAttribute('data-copy-label') || 'Copy';
                        btn.disabled = false;
                        btn._copyFeedbackTimer = null;
                    }, 1200);
                }

                document.addEventListener('click', async (ev) => {
                    const btn = ev.target && ev.target.closest && ev.target.closest('[data-copy-invite-code]');
                    if (!btn) return;
                    const code = btn.getAttribute('data-copy-invite-code');
                    const ok = await copyInviteCode(code);
                    setCopyFeedback(btn, ok);
                });
            </script>
        </div>
        {{end}}
    </div>

    <div class="card">
        {{if eq .RegMode "invite"}}
        <h3 style="margin:0 0 8px;">Create invite code</h3>
        {{else if eq .RegMode "open"}}
        <h3 style="margin:0 0 8px;">Default registration settings</h3>
        {{else}}
        <h3 style="margin:0 0 8px;">Registration settings</h3>
        {{end}}

        {{if eq .RegMode "invite"}}
        <form method="post" action="/admin/invites/create">
            <label>Max uses (0 = unlimited)</label>
            <input name="max_uses" inputmode="numeric" placeholder="0" />

            <label>Expires at (optional)</label>
            <input name="expires_at" type="datetime-local" placeholder="YYYY-MM-DDTHH:MM" />
            <small class="muted" style="display:block; margin-top:4px;">Server time.</small>

            <label>Create home directory</label>
            <div class="seg" style="margin-top:6px;">
                <input id="ch_y" type="radio" name="create_home" value="1" checked />
                <label for="ch_y">Yes</label>
                <input id="ch_n" type="radio" name="create_home" value="0" />
                <label for="ch_n">No</label>
            </div>

            <label style="margin-top: 12px;">User umask (optional)</label>
            <input name="umask" placeholder="022" />
            <small class="muted" style="display:block; margin-top:4px;">Leave empty to use system defaults.</small>

            <label style="margin-top: 12px;">Assign Groups (<span class="muted"
                    data-groups-selected-count="invite">0</span>
                <span class="muted">selected</span>)</label>
            <div data-groups-container="invite"
                style="max-height: 200px; overflow-y: auto; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.2);">
                {{range .FeaturedGroups}}
                {{$groupName := .}}
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="inv_{{.}}" name="groups" value="{{.}}" {{if
                        $.UbuntuDesktopGroups}}{{range $.UbuntuDesktopGroups}}{{if eq .
                        $groupName}}checked{{end}}{{end}}{{end}}
                        style="width: 16px; height: 16px; flex: 0 0 16px; margin: 0;">
                    <label for="inv_{{.}}" style="display:inline; margin-top: 6px;">{{.}}</label>
                </div>
                {{end}}
                {{if .OtherGroups}}
                <details style="margin-top: 5px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 5px;">
                    <summary style="cursor: pointer; font-size: 13px; color: var(--muted); padding: 5px 0;">Show
                        system groups ({{len .OtherGroups}})</summary>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 5px;">
                        {{range .OtherGroups}}
                        {{$groupName := .}}
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="inv_{{.}}" name="groups" value="{{.}}" {{if
                                $.UbuntuDesktopGroups}}{{range $.UbuntuDesktopGroups}}{{if eq .
                                $groupName}}checked{{end}}{{end}}{{end}}
                                style="width: 16px; height: 16px; flex: 0 0 16px; margin: 0;">
                            <label for="inv_{{.}}" style="display:inline; margin-top: 6px;">{{.}}</label>
                        </div>
                        {{end}}
                    </div>
                </details>
                {{end}}
            </div>

            <div style="display:flex; justify-content:flex-end; margin-top: 14px;">
                <button class="btn primary" type="submit">Generate</button>
            </div>
        </form>
        {{else if eq .RegMode "open"}}
        <form method="post" action="/admin/settings/registration" style="margin:0;">
            <input type="hidden" name="mode" value="{{.RegMode}}">
            <input type="hidden" name="default_groups_submit" value="1">

            <label>Create home directory</label>
            <div class="seg" style="margin-top:6px;">
                <input id="ch_open_y" type="radio" name="create_home" value="1" checked />
                <label for="ch_open_y">Yes</label>
                <input id="ch_open_n" type="radio" name="create_home" value="0" />
                <label for="ch_open_n">No</label>
            </div>

            <label style="margin-top: 12px;">Assign Groups (<span class="muted"
                    data-groups-selected-count="open">0</span>
                <span class="muted">selected</span>)</label>
            <div data-groups-container="open"
                style="max-height: 200px; overflow-y: auto; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.2);">
                {{range .FeaturedGroups}}
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="open_{{.}}" name="groups" value="{{.}}" {{$currentGroup :=.}} {{if
                        $.DefaultGroups}} {{range $.DefaultGroups}}{{if eq . $currentGroup}}checked{{end}}{{end}}
                        {{else}} {{if contains $.UbuntuDesktopGroups $currentGroup}}checked{{end}} {{end}}
                        style="width: 16px; height: 16px; flex: 0 0 16px; margin: 0;">
                    <label for="open_{{.}}" style="display:inline; margin-top: 6px;">{{.}}</label>
                </div>
                {{end}}
                {{if .OtherGroups}}
                <details style="margin-top: 5px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 5px;">
                    <summary style="cursor: pointer; font-size: 13px; color: var(--muted); padding: 5px 0;">Show
                        system groups ({{len .OtherGroups}})</summary>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 5px;">
                        {{range .OtherGroups}}
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="open_sys_{{.}}" name="groups" value="{{.}}" {{$currentGroup :=.}}
                                {{if $.DefaultGroups}} {{range $.DefaultGroups}}{{if eq .
                                $currentGroup}}checked{{end}}{{end}} {{end}}
                                style="width: 16px; height: 16px; flex: 0 0 16px; margin: 0;">
                            <label for="open_sys_{{.}}" style="display:inline; margin-top: 6px;">{{.}}</label>
                        </div>
                        {{end}}
                    </div>
                </details>
                {{end}}
            </div>

            <div style="display:flex; justify-content:flex-end; margin-top: 14px;">
                <button class="btn primary" type="submit">Save Defaults</button>
            </div>
        </form>
        {{else}}
        <div class="muted" style="padding: 20px; text-align: center;">Registration is currently closed.</div>
        {{end}}

        <script>
            (function () {
                function initGroupsSelectedCount(section) {
                    const container = document.querySelector('[data-groups-container="' + section + '"]');
                    const countEl = document.querySelector('[data-groups-selected-count="' + section + '"]');
                    if (!container || !countEl) return;

                    const update = () => {
                        const n = container.querySelectorAll('input[type="checkbox"]:checked').length;
                        countEl.textContent = String(n);
                    };

                    update();

                    container.addEventListener('change', (ev) => {
                        const t = ev && ev.target;
                        if (t && t.matches && t.matches('input[type="checkbox"]')) {
                            update();
                        }
                    });
                }

                function init() {
                    initGroupsSelectedCount('invite');
                    initGroupsSelectedCount('open');
                }

                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', init);
                } else {
                    init();
                }
            })();
        </script>
    </div>
</div>
{{end}}