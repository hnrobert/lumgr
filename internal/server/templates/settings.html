{{define "title"}}Settings Â· lumgr{{end}}
{{define "content"}}
<div class="grid">

    <form method="post" action="/settings">
        <div class="card">
            <h2 style="margin:0 0 8px;">Shell</h2>
            <div class="muted">These settings are stored in your home directory.</div>

            <label>Default Shell</label>
            <select name="shell">
                {{range .AvailableShells}}
                <option value="{{.}}" {{if eq . $.Shell}}selected{{end}}>{{.}}</option>
                {{end}}
            </select>

            <label>Preferred terminal type (TERM)</label>
            <input name="term" placeholder="xterm-256color" value="{{.Term}}" />

            <label>Login redirect directory (optional)</label>
            <input name="redirect" placeholder="/home/{{.Username}}/example-directory" value="{{.Redirect}}" />

            <div style="display:flex; justify-content:flex-end; margin-top: 14px;">
                <button class="btn primary" type="submit" name="section" value="shell">Save</button>
            </div>
        </div>

        <div class="card">
            <h2 style="margin:0 0 8px;">SSH</h2>
            <div class="muted" style="margin-bottom: 12px;">Manage <code>~/.ssh/authorized_keys</code>.</div>

            <label>SSH authorized_keys</label>
            <textarea name="ssh_keys" placeholder="ssh-rsa AAAAB3QB3U7EAr1v... user@example.com
ssh-ed25519 AAAAC3NzAIC3... user2@example.com" spellcheck="false">{{.SSHKeys}}</textarea>

            <div style="display:flex; justify-content:flex-end; margin-top: 14px;">
                <button class="btn primary" type="submit" name="section" value="ssh">Save</button>
            </div>
        </div>

        <div class="card">
            <h2 style="margin:0 0 8px;">Git</h2>
            <div class="muted" style="margin-bottom: 12px;">Config stored in <code>~/.gitconfig</code>.</div>

            <div class="row">
                <div>
                    <label>Git user.name</label>
                    <input name="git_name" placeholder="Your Git Name" value="{{.GitName}}" />
                </div>
                <div>
                    <label>Git user.email</label>
                    <input name="git_email" placeholder="name@example.com" value="{{.GitEmail}}" />
                </div>
            </div>

            <label>Git SSH signing key (private key path)</label>
            <select name="git_signing_key">
                <option value="">(none)</option>
                {{range .SSHPrivateKeys}}
                <option value="{{.}}" {{if eq . $.GitSigningKey}}selected{{end}}>{{.}}</option>
                {{end}}
            </select>
            <small class="muted" style="display:block; margin-top:4px;">Or enter another path under your home
                directory:</small>
            <input name="git_signing_key_other" placeholder="~/.ssh/id_ed25519" />

            {{if .GitSigningPub}}
            <label style="margin-top: 12px;">Signing public key</label>
            <div style="display:flex; gap:8px; align-items:flex-start;">
                <textarea id="gitSigningPub" readonly spellcheck="false"
                    style="min-height:72px;">{{.GitSigningPub}}</textarea>
                <button class="btn small" type="button" data-copy-textarea="gitSigningPub"
                    style="width:84px; text-align:center;">Copy</button>
            </div>
            <small class="muted" style="display:block; margin-top:6px;">Tip: enable SSH signing with
                <code>git config --global gpg.format ssh</code> and set <code>user.signingkey</code> to your key
                path.</small>
            {{end}}

            <div style="display:flex; justify-content:flex-end; margin-top: 14px;">
                <button class="btn primary" type="submit" name="section" value="git">Save</button>
            </div>
        </div>

        <div class="card">
            <h2 style="margin:0 0 8px;">Save All</h2>
            <div class="muted" style="margin-bottom: 12px;">Saves Shell + SSH + Git in one submit.</div>
            <div style="display:flex; justify-content:flex-end;">
                <button class="btn primary" type="submit" name="section" value="all">Save all</button>
            </div>
        </div>
    </form>

    <div class="card">
        <h2 style="margin:0 0 8px;">SSH keypair generation</h2>
        <div class="muted" style="margin-bottom: 12px;">Generates a key under <code>~/.ssh/</code>.</div>

        <form method="post" action="/settings/ssh/keygen">
            <div class="row">
                <div>
                    <label>Key type</label>
                    <select name="key_type">
                        <option value="rsa" selected>rsa (4096)</option>
                        <option value="ed25519">ed25519</option>
                        <option value="ecdsa">ecdsa</option>
                    </select>
                </div>
                <div>
                    <label>Filename</label>
                    <input name="key_file" placeholder="id_rsa" />
                </div>
            </div>

            <label>Comment (optional)</label>
            <input name="key_comment" placeholder="{{.Username}}" />

            <label>Passphrase (optional)</label>
            <input type="password" name="key_passphrase" autocomplete="new-password" />

            <div style="display:flex; justify-content:flex-end; margin-top: 14px;">
                <button class="btn primary" type="submit">Generate</button>
            </div>
        </form>
    </div>

    <div class="card">
        <h2 style="margin:0 0 8px;">File Permissions</h2>
        <div class="muted" style="margin-bottom: 12px;">Recursively apply chmod to your home (skips .ssh).</div>

        <form method="post" action="{{.PermFormAction}}">
            {{template "perms_table" .}}

            <div style="display:flex; justify-content:flex-end; margin-top: 14px;">
                <button class="btn danger" type="submit">{{.PermSubmitLabel}}</button>
            </div>
        </form>
    </div>

    <div class="card">
        <h2 style="margin:0 0 8px;">Default umask</h2>
        <div class="muted" style="margin-bottom: 12px;">Used when creating new files and directories.</div>

        <form method="post" action="{{.PermUmaskFormAction}}" style="display:flex; gap:8px; align-items:center;">
            <input name="umask" placeholder="022" value="{{.PermUmaskValue}}" style="width:80px;" />
            <button class="btn primary small" type="submit">Save</button>
        </form>
    </div>

    <div class="card">
        <h2 style="margin:0 0 8px;">Change password</h2>
        <div class="muted" style="margin-bottom: 12px;">Update your host Linux account password.</div>
        <form method="post" action="/settings/password">
            <label>Current password</label>
            <input type="password" name="current_password" autocomplete="current-password" required />

            <label>New password</label>
            <input type="password" name="new_password" autocomplete="new-password" required />

            <label>Confirm new password</label>
            <input type="password" name="new_password2" autocomplete="new-password" required />

            <div style="display:flex; justify-content:flex-end; margin-top: 14px;">
                <button class="btn primary" type="submit">Update password</button>
            </div>
        </form>
    </div>

</div>

<script>
    async function copyText(text) {
        if (!text) return false;
        const value = text.trim();
        try {
            await navigator.clipboard.writeText(value);
            return true;
        } catch (e) {
            try {
                const el = document.createElement('textarea');
                el.value = value;
                el.setAttribute('readonly', '');
                el.style.position = 'absolute';
                el.style.left = '-9999px';
                document.body.appendChild(el);
                el.select();
                const ok = document.execCommand('copy');
                document.body.removeChild(el);
                return !!ok;
            } catch (e2) {
                return false;
            }
        }
    }

    function setCopyFeedback(btn, ok) {
        if (!btn) return;
        const original = btn.getAttribute('data-copy-label') || btn.textContent;
        if (!btn.getAttribute('data-copy-label')) {
            btn.setAttribute('data-copy-label', original);
        }
        if (btn._copyFeedbackTimer) {
            clearTimeout(btn._copyFeedbackTimer);
        }
        btn.textContent = ok ? 'Copied!' : 'Failed';
        btn.disabled = true;
        btn._copyFeedbackTimer = setTimeout(() => {
            btn.textContent = btn.getAttribute('data-copy-label') || 'Copy';
            btn.disabled = false;
            btn._copyFeedbackTimer = null;
        }, 1200);
    }

    document.addEventListener('click', async (ev) => {
        const btn = ev.target && ev.target.closest && ev.target.closest('[data-copy-textarea]');
        if (!btn) return;
        const id = btn.getAttribute('data-copy-textarea');
        const el = document.getElementById(id);
        const ok = await copyText(el ? el.value : '');
        setCopyFeedback(btn, ok);
    });
</script>
{{end}}