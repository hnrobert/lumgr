{{define "title"}}Resource Monitor Â· lumgr{{end}}
{{define "content"}}
<div class="grid" style="gap:16px;">
    <div class="card">
        <h2 style="margin:0 0 8px;">Resource Monitor Configuration</h2>
        <form method="post" action="/admin/resources/config">
            <div class="row">
                <div>
                    <label>Collect interval (seconds)</label>
                    <input type="number" min="1" name="interval_seconds" value="{{.ResmonConfig.IntervalSeconds}}" />
                </div>
                <div>
                    <label>Retention (days)</label>
                    <input type="number" min="1" max="365" name="retention_days"
                        value="{{.ResmonConfig.RetentionDays}}" />
                </div>
            </div>

            <div class="row" style="margin-top:8px;">
                <label><input type="checkbox" name="enabled" value="1" {{if .ResmonConfig.Enabled}}checked{{end}}
                        style="width:auto; margin-right:6px;" />Enabled</label>
                <label><input type="checkbox" name="collect_cpu" value="1" {{if .ResmonConfig.CollectCPU}}checked{{end}}
                        style="width:auto; margin-right:6px;" />CPU</label>
                <label><input type="checkbox" name="collect_memory" value="1" {{if
                        .ResmonConfig.CollectMemory}}checked{{end}}
                        style="width:auto; margin-right:6px;" />Memory</label>
                <label><input type="checkbox" name="collect_disk_io" value="1" {{if
                        .ResmonConfig.CollectDiskIO}}checked{{end}} style="width:auto; margin-right:6px;" />Disk
                    IO</label>
                <label><input type="checkbox" name="collect_filesystem" value="1" {{if
                        .ResmonConfig.CollectFilesystem}}checked{{end}}
                        style="width:auto; margin-right:6px;" />Filesystem</label>
                <label><input type="checkbox" name="collect_network" value="1" {{if
                        .ResmonConfig.CollectNetwork}}checked{{end}}
                        style="width:auto; margin-right:6px;" />Network</label>
                <label><input type="checkbox" name="collect_user_stats" value="1" {{if
                        .ResmonConfig.CollectUserStats}}checked{{end}} style="width:auto; margin-right:6px;" />User
                    stats</label>
            </div>

            <div style="display:flex; justify-content:flex-end; margin-top:12px;">
                <button class="btn primary" type="submit">Save configuration</button>
            </div>
        </form>
    </div>

    <div class="grid two">
        <div class="card">
            <h3 style="margin:0 0 8px;">Current CPU & Memory</h3>
            <div class="muted">CPU usage: <strong><span id="admin-resmon-cpu">{{if .CurrentMetrics}}{{printf "%.1f"
                        .CurrentMetrics.CPUUsage}}{{else}}0.0{{end}}</span>%</strong></div>
            <div class="muted" style="margin-top:4px;">Memory usage: <strong id="admin-resmon-mem-used">{{if
                    .CurrentMetrics}}{{bytes .CurrentMetrics.MemUsed}}{{else}}0 B{{end}}</strong>
                / <span id="admin-resmon-mem-total">{{if .CurrentMetrics}}{{bytes .CurrentMetrics.MemTotal}}{{else}}0
                    B{{end}}</span></div>
        </div>
        <div class="card">
            <h3 style="margin:0 0 8px;">Current Disk & Network</h3>
            <div class="muted">Disk read/write: <strong id="admin-resmon-disk-r">{{if .CurrentMetrics}}{{bytes
                    .CurrentMetrics.DiskReadBytes}}{{else}}0 B{{end}}</strong> /
                <strong id="admin-resmon-disk-w">{{if .CurrentMetrics}}{{bytes .CurrentMetrics.DiskWriteBytes}}{{else}}0
                    B{{end}}</strong>
            </div>
            <div class="muted" style="margin-top:4px;">Network rx/tx: <strong id="admin-resmon-net-rx">{{if
                    .CurrentMetrics}}{{bytes .CurrentMetrics.NetworkRxBytes}}{{else}}0 B{{end}}</strong> /
                <strong id="admin-resmon-net-tx">{{if .CurrentMetrics}}{{bytes .CurrentMetrics.NetworkTxBytes}}{{else}}0
                    B{{end}}</strong>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 style="margin:0 0 8px;">History</h2>
        <form method="get" action="/admin/resources"
            style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; margin-bottom:10px;">
            <div>
                <label>Window (hours)</label>
                <input type="number" name="hours" value="24" min="1" max="720" style="width:120px;" />
            </div>
            <div>
                <label>User filter</label>
                <select name="user" style="min-width:180px;">
                    <option value="">(all users)</option>
                    {{range .ResmonUsers}}
                    <option value="{{.}}" {{if eq $.ResmonSelectedUser .}}selected{{end}}>{{.}}</option>
                    {{end}}
                </select>
            </div>
            <button class="btn" type="submit">Apply</button>
        </form>

        {{if .ResmonHistory}}
        <div style="height:260px; min-height:260px; max-height:260px; position:relative;">
            <canvas id="cpuChart"></canvas>
        </div>
        <div style="height:12px"></div>
        <div style="height:260px; min-height:260px; max-height:260px; position:relative;">
            <canvas id="memChart"></canvas>
        </div>
        <div style="height:12px"></div>
        <div style="height:260px; min-height:260px; max-height:260px; position:relative;">
            <canvas id="diskIoChart"></canvas>
        </div>
        <div style="height:12px"></div>
        <div style="height:260px; min-height:260px; max-height:260px; position:relative;">
            <canvas id="netIoChart"></canvas>
        </div>
        <div style="height:12px"></div>
        <div style="height:260px; min-height:260px; max-height:260px; position:relative;">
            <canvas id="userChart"></canvas>
        </div>
        {{else}}
        <div class="muted">No history samples yet. Wait for at least one collection interval.</div>
        {{end}}
    </div>
</div>

{{if .ResmonHistory}}
<script src="/assets/vendor/chart.min.js"></script>
<script id="resmonHistoryData" type="application/json">{{toJSON .ResmonHistory}}</script>
<script id="resmonLatestUsersData" type="application/json">{{toJSON .ResmonLatestUsers}}</script>
<script>
    if (window.__lumgrAdminResmonChartsInit) {
        // prevent duplicate chart/timer setup on accidental duplicate script execution
    } else {
        window.__lumgrAdminResmonChartsInit = true;

        const history = JSON.parse(document.getElementById('resmonHistoryData')?.textContent || '[]');
        const latestUsers = JSON.parse(document.getElementById('resmonLatestUsersData')?.textContent || '[]');
        const formatBytes = (v) => {
            v = Number(v) || 0;
            const units = ['B', 'KiB', 'MiB', 'GiB', 'TiB', 'PiB'];
            let i = 0;
            while (v >= 1024 && i < units.length - 1) { v /= 1024; i++; }
            if (i === 0) return Math.round(v) + ' B';
            return v.toFixed(1) + ' ' + units[i];
        };

        const labels = history.map((s) => {
            const d = new Date(s.timestamp);
            if (Number.isNaN(d.getTime())) return "";
            return d.toLocaleTimeString();
        });
        const cpuUsage = history.map((s) => Number((s.metrics && s.metrics.cpu_usage) || 0));
        const memUsed = history.map((s) => Number((s.metrics && s.metrics.mem_used) || 0));
        const memTotal = history.map((s) => Number((s.metrics && s.metrics.mem_total) || 0));
        const maxMem = Math.max(1, ...memTotal);
        const diskR = history.map((s) => Number((s.metrics && s.metrics.disk_read_bytes) || 0));
        const diskW = history.map((s) => Number((s.metrics && s.metrics.disk_write_bytes) || 0));
        const netRx = history.map((s) => Number((s.metrics && s.metrics.network_rx_bytes) || 0));
        const netTx = history.map((s) => Number((s.metrics && s.metrics.network_tx_bytes) || 0));

        const userLabels = latestUsers.map((u) => String(u.username || ""));
        const userCpu = latestUsers.map((u) => Number(u.cpu_percent || 0));

        new Chart(document.getElementById('cpuChart'), {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { label: 'CPU %', data: cpuUsage, borderColor: '#7aa2ff', backgroundColor: 'rgba(122,162,255,0.15)' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                scales: { y: { min: 0, max: 100 } }
            }
        });

        new Chart(document.getElementById('memChart'), {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { label: 'Mem Used', data: memUsed, borderColor: '#3ddc97', backgroundColor: 'rgba(61,220,151,0.15)' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                scales: {
                    y: {
                        min: 0,
                        max: maxMem,
                        ticks: {
                            callback: function (value) { return formatBytes(value); }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function (ctx) {
                                const used = Number(ctx.parsed.y || 0);
                                const total = Number(memTotal[ctx.dataIndex] || 0);
                                const pct = total > 0 ? (used / total) * 100 : 0;
                                return 'Mem Used: ' + formatBytes(used) + ' (' + pct.toFixed(1) + '%)';
                            }
                        }
                    }
                }
            }
        });

        new Chart(document.getElementById('diskIoChart'), {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { label: 'Disk Read Bytes', data: diskR, borderColor: '#f2c879' },
                    { label: 'Disk Write Bytes', data: diskW, borderColor: '#ff8f8f' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, animation: false }
        });

        new Chart(document.getElementById('netIoChart'), {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { label: 'Net Rx Bytes', data: netRx, borderColor: '#86d6ff' },
                    { label: 'Net Tx Bytes', data: netTx, borderColor: '#c48fff' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, animation: false }
        });

        new Chart(document.getElementById('userChart'), {
            type: 'bar',
            data: {
                labels: userLabels,
                datasets: [{ label: 'User CPU share %', data: userCpu, backgroundColor: 'rgba(122,162,255,0.4)' }]
            },
            options: { responsive: true, maintainAspectRatio: false, animation: false }
        });
    }
</script>
{{end}}

<script>
    (function () {
        if (window.__lumgrAdminResmonCardsInit) return;
        window.__lumgrAdminResmonCardsInit = true;

        const formatBytes = (v) => {
            v = Number(v) || 0;
            const units = ['B', 'KiB', 'MiB', 'GiB', 'TiB', 'PiB'];
            let i = 0;
            while (v >= 1024 && i < units.length - 1) { v /= 1024; i++; }
            if (i === 0) return Math.round(v) + ' B';
            return v.toFixed(1) + ' ' + units[i];
        };
        const setText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };

        async function refreshCards() {
            try {
                const res = await fetch('/api/resmon/current', { cache: 'no-store' });
                if (!res.ok) return;
                const payload = await res.json();
                const sm = payload.sample || payload;
                const m = sm.metrics || sm.Metrics || {};

                setText('admin-resmon-cpu', (Number(m.cpu_usage ?? m.CPUUsage ?? 0)).toFixed(1));
                setText('admin-resmon-mem-used', formatBytes(m.mem_used ?? m.MemUsed ?? 0));
                setText('admin-resmon-mem-total', formatBytes(m.mem_total ?? m.MemTotal ?? 0));
                setText('admin-resmon-disk-r', formatBytes(m.disk_read_bytes ?? m.DiskReadBytes ?? 0));
                setText('admin-resmon-disk-w', formatBytes(m.disk_write_bytes ?? m.DiskWriteBytes ?? 0));
                setText('admin-resmon-net-rx', formatBytes(m.network_rx_bytes ?? m.NetworkRxBytes ?? 0));
                setText('admin-resmon-net-tx', formatBytes(m.network_tx_bytes ?? m.NetworkTxBytes ?? 0));
            } catch (e) {
                // silent
            }
        }

        refreshCards();
        const timerId = setInterval(refreshCards, 1000);
        window.addEventListener('beforeunload', function () {
            clearInterval(timerId);
            window.__lumgrAdminResmonCardsInit = false;
        });
    })();
</script>
{{end}}